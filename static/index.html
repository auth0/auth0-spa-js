<!DOCTYPE html>
<html>
  <head>
    <title>Auth0</title>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <h3>User:</h3>
    <pre id="user"></pre>
    <h3>Token:</h3>
    <pre id="token"></pre>

    <button id="hundred">Mimic opening a new tab</button>

    <script src="/auth0-spa-js.development.js"></script>
    <script type="text/javascript">
      var defaultDomain = 'brucke.auth0.com';
      var defaultClientId = 'wLSIP47wM39wKdDmOj6Zb5eSEw3JVhVp';
      // Auth0 setup
      const a0config = {
        client_id: 'IJ1pIAk1G4Fd5D0elgte3EifRwfIscVx',
        //client_id: defaultClientId,
        //domain: defaultDomain,
        domain: 'frdrkprck.eu.auth0.com',
        audience: 'Test',
        redirect_uri: 'http://localhost:3000/',
        cacheLocation: 'localstorage',
        useRefreshTokens: true
      };

      const a0 = new Auth0Client(a0config);

      function login() {
        return a0.isAuthenticated().then(isAuthenticated => {
          if (isAuthenticated) {
            // console.warn('Already authenticated');
            return a0.getUser();
          } else {
            return a0
              .handleRedirectCallback()
              .then(() => {
                // console.warn('Auth callback handled.');
                return a0.getUser();
              })
              .catch(() => {
                return a0.loginWithRedirect();
              });
          }
        });
      }

      function getToken() {
        return a0.getTokenSilently();
      }

      // Demo UI
      function displayUser(user) {
        document.querySelector('#user').innerText = JSON.stringify(user);
      }

      function displayToken(token) {
        document.querySelector('#token').innerText = token;
      }

      // Init logic
      login().then(displayUser);

      function expireToken() {
        const k =
          '@@auth0spajs@@::IJ1pIAk1G4Fd5D0elgte3EifRwfIscVx::Test::openid profile email offline_access';
        const json = localStorage.getItem(k);
        if (json) {
          const tokens = JSON.parse(json);
          tokens.expiresAt = 1;
          localStorage.setItem(k, JSON.stringify(tokens));
        }
      }

      function sleep(ms) {
        return function (x) {
          return new Promise(resolve => setTimeout(() => resolve(x), ms));
        };
      }

      function jitter(p) {
        // We perform real network requests, so this function is meant to mimic
        // the random delay those might cause
        return Promise.resolve()
          .then(sleep(1000 * Math.random()))
          .then(p);
      }

      let counter = 1;
      function mimicInitializationLogic() {
        // expire token to mimic opening a new tab after a while
        expireToken();

        // on every app init we populate our app's state with the user data, only once
        jitter(() => a0.isAuthenticated()).then(() => {
          // console.log('getUser');
          a0.getUser();
          a0.getIdTokenClaims();
        });

        // in different places throughout the app we do two things:
        // the number "30" is not random here - that's the actual number of how many times
        // we might call the Auth0 API functions when a user opens a new tab
        for (let i = 0; i < 30; i++) {
          // - we get the token and talk to our servers
          jitter(() => {
            // console.log('getTokenSilently');
            a0.getTokenSilently({ ignoreCache: true });
          });
          // - we check if user is authenticated to make decisions in different parts of the application
          jitter(() => {
            // console.log('isAuthenticated');
            a0.isAuthenticated();
          });
        }

        console.log('-----', counter, '-----');
        counter++;
      }

      document
        .querySelector('#hundred')
        .addEventListener('click', mimicInitializationLogic);
    </script>
  </body>
</html>
