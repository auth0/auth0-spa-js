<!DOCTYPE html>
<html>

<head>
    <title>Auth0 - MFA APIs Integration</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
    <script src="/auth0-spa-js.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<body class="bg-light">
    <div id="app" class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4">Auth0 MFA APIs Integration</h2>

                        <!-- Configuration Form -->
                        <form @submit.prevent="initClient" class="mb-3" v-if="!isAuthenticated">
                            <div class="form-group">
                                <label for="domain">Domain</label>
                                <input id="domain" v-model="domain" required class="form-control" />
                                <small class="form-text text-muted">
                                    Your Auth0 tenant domain (e.g., dev-xxx.us.auth0.com)
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="clientId">Client ID</label>
                                <input id="clientId" v-model="clientId" required class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="audience">Audience</label>
                                <input id="audience" v-model="audience" class="form-control" />
                                <small class="form-text text-muted">
                                    Optional API identifier (e.g., email-api)
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="scopes">Scopes</label>
                                <input id="scopes" v-model="scopes" class="form-control" />
                                <small class="form-text text-muted">
                                    Default: <code>openid profile email</code>
                                </small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Login with Auth0</button>
                        </form>

                        <!-- User Profile Card -->
                        <div v-if="isAuthenticated && user" class="card bg-light mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Logged In</h5>
                                <div class="d-flex align-items-center mb-3">
                                    <img v-if="user.picture" :src="user.picture" class="rounded-circle mr-3" width="60"
                                        height="60" />
                                    <div>
                                        <p class="mb-0"><strong>{{ user.name || user.email }}</strong></p>
                                        <p class="mb-0 text-muted">{{ user.email }}</p>
                                    </div>
                                </div>
                                <button @click="logout" class="btn btn-outline-secondary btn-sm">Logout</button>
                                <button @click="resetMfaFlow" class="btn btn-outline-primary btn-sm ml-2">Reset</button>
                            </div>
                        </div>

                        <!-- MFA Trigger Section -->
                        <div v-if="isAuthenticated" class="mb-3">
                            <button @click="triggerMFA" class="btn btn-success btn-block" :disabled="mfaToken">
                                Get token silently (Trigger MFA)
                            </button>
                        </div>

                        <!-- MFA Requirements Display -->
                        <div v-if="mfaToken && mfaRequirements" class="alert alert-info mt-3">
                            <h6>MFA Required</h6>
                            <pre class="bg-white p-3 border rounded mb-0"
                                style="max-height: 200px; overflow-y: auto;">{{ JSON.stringify(mfaRequirements, null, 2) }}</pre>
                            <p class="mb-0 mt-2"><strong>MFA Token:</strong>
                                <code>{{ mfaToken.substring(0, 20) }}...</code>
                            </p>
                        </div>

                        <!-- Success Message -->
                        <div v-if="successMessage" class="alert alert-success mt-3">
                            <h6>{{ successMessage }}</h6>
                            <div v-if="tokens" class="mt-2">
                                <p class="mb-1"><strong>Access Token:</strong></p>
                                <code class="d-block bg-white p-2 border rounded text-dark"
                                    style="word-break: break-all;">{{ tokens.access_token.substring(0, 100) }}...</code>
                                <p class="mb-1 mt-2"><strong>ID Token:</strong></p>
                                <code class="d-block bg-white p-2 border rounded text-dark"
                                    style="word-break: break-all;">{{ tokens.id_token ? tokens.id_token.substring(0, 100) + '...' : 'N/A' }}</code>
                            </div>
                        </div>

                        <!-- Authenticators List -->
                        <div v-if="mfaToken" class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Authenticators</h5>
                                <div v-if="loadingAuthenticators" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Loading authenticators...</p>
                                </div>
                                <div v-else-if="authenticators.length">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Type</th>
                                                    <th>ID</th>
                                                    <th>Active</th>
                                                    <th>Name</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="auth in authenticators" :key="auth.id">
                                                    <td><span class="badge badge-primary">{{ auth.authenticatorType
                                                            }}</span></td>
                                                    <td><code>{{ auth.id }}</code></td>
                                                    <td>
                                                        <span v-if="auth.active"
                                                            class="badge badge-success">Active</span>
                                                        <span v-else class="badge badge-secondary">Inactive</span>
                                                    </td>
                                                    <td>{{ auth.name || '-' }}</td>
                                                    <td>
                                                        <button @click="challenge(auth)" class="btn btn-sm btn-primary"
                                                            :disabled="!auth.active">
                                                            Verify
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <p v-else class="text-muted mb-0">No authenticators found.</p>
                            </div>
                        </div>

                        <!-- Enrollment Form -->
                        <div v-if="mfaToken" class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Enroll New Authenticator</h5>

                                <div v-if="!enrollmentType" class="list-group">
                                    <p class="text-muted mb-3">Available enrollment options:</p>
                                    <button v-for="option in enrollmentOptions" :key="option.type"
                                        @click="selectEnrollmentType(option.type)"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <span>
                                            <strong>{{ option.label }}</strong>
                                            <br>
                                            <small class="text-muted">{{ option.description }}</small>
                                        </span>
                                        <span class="badge badge-primary badge-pill">Enroll</span>
                                    </button>
                                </div>

                                <div v-else>
                                    <!-- OTP Enrollment -->
                                    <div v-if="enrollmentType === 'otp'">
                                        <div v-if="loadingEnrollment" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            <p class="text-muted mt-2">Setting up authenticator...</p>
                                        </div>

                                        <div v-else-if="enrollmentData">
                                            <div class="alert alert-info">
                                                <p class="mb-2"><strong>Scan this QR code with your authenticator
                                                        app:</strong></p>
                                                <div class="text-center my-3">
                                                    <img :src="enrollmentData.barcodeUri" alt="QR Code"
                                                        class="img-fluid" style="max-width: 200px;" />
                                                </div>
                                                <p class="mb-1"><strong>Or enter this secret manually:</strong></p>
                                                <code
                                                    class="d-block bg-white p-2 border rounded">{{ enrollmentData.secret }}</code>
                                            </div>

                                            <form @submit.prevent="verifyEnrollment" class="mt-3">
                                                <div class="form-group">
                                                    <label for="enrollOtp">Enter code from authenticator app</label>
                                                    <input id="enrollOtp" v-model="enrollmentVerificationCode"
                                                        type="text" class="form-control" placeholder="123456" required
                                                        :disabled="loadingEnrollmentVerification" />
                                                </div>
                                                <button type="submit" class="btn btn-success btn-block"
                                                    :disabled="loadingEnrollmentVerification || !enrollmentVerificationCode">
                                                    <span v-if="loadingEnrollmentVerification">
                                                        <span class="spinner-border spinner-border-sm"
                                                            role="status"></span>
                                                        Verifying...
                                                    </span>
                                                    <span v-else>Complete Enrollment</span>
                                                </button>
                                                <button type="button" @click="cancelEnrollment"
                                                    class="btn btn-outline-secondary btn-block mt-2"
                                                    :disabled="loadingEnrollmentVerification">
                                                    Cancel
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- SMS/Voice Enrollment -->
                                    <div v-else-if="enrollmentType === 'sms' || enrollmentType === 'voice'">
                                        <form v-if="!enrollmentData" @submit.prevent="enrollOob" class="mt-3">
                                            <div class="form-group">
                                                <label for="phoneNumber">Phone Number (E.164 format)</label>
                                                <input id="phoneNumber" v-model="phoneNumber" type="tel"
                                                    class="form-control" placeholder="+12025551234" required
                                                    :disabled="loadingEnrollment" />
                                                <small class="form-text text-muted">Include country code (e.g., +1 for
                                                    US)</small>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-block"
                                                :disabled="loadingEnrollment || !phoneNumber">
                                                <span v-if="loadingEnrollment">
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                    Enrolling...
                                                </span>
                                                <span v-else>Send Code</span>
                                            </button>
                                            <button type="button" @click="cancelEnrollment"
                                                class="btn btn-outline-secondary btn-block mt-2"
                                                :disabled="loadingEnrollment">
                                                Cancel
                                            </button>
                                        </form>

                                        <div v-else>
                                            <div class="alert alert-info">
                                                <p class="mb-0">A verification code has been sent to <strong>{{
                                                        phoneNumber }}</strong></p>
                                            </div>

                                            <form @submit.prevent="verifyEnrollment" class="mt-3">
                                                <div class="form-group">
                                                    <label for="enrollOobCode">Enter verification code</label>
                                                    <input id="enrollOobCode" v-model="enrollmentVerificationCode"
                                                        type="text" class="form-control" placeholder="123456" required
                                                        :disabled="loadingEnrollmentVerification" />
                                                </div>
                                                <button type="submit" class="btn btn-success btn-block"
                                                    :disabled="loadingEnrollmentVerification || !enrollmentVerificationCode">
                                                    <span v-if="loadingEnrollmentVerification">
                                                        <span class="spinner-border spinner-border-sm"
                                                            role="status"></span>
                                                        Verifying...
                                                    </span>
                                                    <span v-else>Complete Enrollment</span>
                                                </button>
                                                <button type="button" @click="cancelEnrollment"
                                                    class="btn btn-outline-secondary btn-block mt-2"
                                                    :disabled="loadingEnrollmentVerification">
                                                    Cancel
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Email Enrollment -->
                                    <div v-else-if="enrollmentType === 'email'">
                                        <form v-if="!enrollmentData" @submit.prevent="enrollEmail" class="mt-3">
                                            <div class="form-group">
                                                <label for="emailAddress">Email Address</label>
                                                <input id="emailAddress" v-model="emailAddress" type="email"
                                                    class="form-control" placeholder="user@example.com"
                                                    :disabled="loadingEnrollment" />
                                                <small class="form-text text-muted">Leave empty to use your account
                                                    email</small>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-block"
                                                :disabled="loadingEnrollment">
                                                <span v-if="loadingEnrollment">
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                    Enrolling...
                                                </span>
                                                <span v-else>Send Code</span>
                                            </button>
                                            <button type="button" @click="cancelEnrollment"
                                                class="btn btn-outline-secondary btn-block mt-2"
                                                :disabled="loadingEnrollment">
                                                Cancel
                                            </button>
                                        </form>

                                        <div v-else>
                                            <div class="alert alert-info">
                                                <p class="mb-0">A verification code has been sent to your email</p>
                                            </div>

                                            <form @submit.prevent="verifyEnrollment" class="mt-3">
                                                <div class="form-group">
                                                    <label for="enrollEmailCode">Enter verification code</label>
                                                    <input id="enrollEmailCode" v-model="enrollmentVerificationCode"
                                                        type="text" class="form-control" placeholder="123456" required
                                                        :disabled="loadingEnrollmentVerification" />
                                                </div>
                                                <button type="submit" class="btn btn-success btn-block"
                                                    :disabled="loadingEnrollmentVerification || !enrollmentVerificationCode">
                                                    <span v-if="loadingEnrollmentVerification">
                                                        <span class="spinner-border spinner-border-sm"
                                                            role="status"></span>
                                                        Verifying...
                                                    </span>
                                                    <span v-else>Complete Enrollment</span>
                                                </button>
                                                <button type="button" @click="cancelEnrollment"
                                                    class="btn btn-outline-secondary btn-block mt-2"
                                                    :disabled="loadingEnrollmentVerification">
                                                    Cancel
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Challenge/Verification Form -->
                        <div v-if="selectedAuthenticator" class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Verify MFA Challenge</h5>
                                <p class="mb-2">
                                    <strong>Authenticator:</strong>
                                    <span class="badge badge-primary">{{ selectedAuthenticator.authenticatorType
                                        }}</span>
                                    <code class="ml-2">{{ selectedAuthenticator.id }}</code>
                                </p>

                                <div v-if="loadingChallenge" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <p class="text-muted mt-2">Initiating challenge...</p>
                                </div>

                                <div v-else-if="challengeData">
                                    <div v-if="challengeData.oobCode" class="alert alert-info">
                                        <p class="mb-0"><strong>OOB Code:</strong>
                                            <code>{{ challengeData.oobCode }}</code>
                                        </p>
                                        <small>A code has been sent. Please check your device.</small>
                                    </div>

                                    <form @submit.prevent="verifyChallenge" class="mt-3">
                                        <div class="form-group">
                                            <label for="verificationCode">Enter Verification Code</label>
                                            <input id="verificationCode" v-model="verificationCode" type="text"
                                                class="form-control" placeholder="e.g., 123456" required
                                                :disabled="loadingVerification" />
                                        </div>
                                        <button type="submit" class="btn btn-success btn-block"
                                            :disabled="loadingVerification || !verificationCode">
                                            <span v-if="loadingVerification">
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                                Verifying...
                                            </span>
                                            <span v-else>Verify Code</span>
                                        </button>
                                        <button type="button" @click="cancelVerification"
                                            class="btn btn-outline-secondary btn-block mt-2"
                                            :disabled="loadingVerification">
                                            Cancel
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Recovery Codes Section -->
                        <div v-if="mfaToken" class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Recovery Codes</h5>

                                <div>
                                    <div class="alert alert-warning">
                                        <strong>⚠️ Save these codes securely!</strong> Each code can only be used once.
                                    </div>
                                    <div class="bg-light p-3 border rounded mb-3">
                                        <code v-for="(code, index) in recoveryCodes" :key="index"
                                            class="d-block">{{ code }}</code>
                                    </div>

                                    <form @submit.prevent="verifyWithRecoveryCode" class="mt-3">
                                        <div class="form-group">
                                            <label for="recoveryCodeInput">Use a Recovery Code</label>
                                            <input id="recoveryCodeInput" v-model="recoveryCodeInput" type="text"
                                                class="form-control" placeholder="XXXX-XXXX-XXXX"
                                                :disabled="loadingRecoveryVerification" />
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-block"
                                            :disabled="loadingRecoveryVerification || !recoveryCodeInput">
                                            <span v-if="loadingRecoveryVerification">
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                                Verifying...
                                            </span>
                                            <span v-else>Verify with Recovery Code</span>
                                        </button>
                                    </form>
                                </div>

                                <p v-else class="text-muted mb-0">Recovery codes will appear here after enrollment...
                                </p>
                            </div>
                        </div>

                        <!-- Error Display -->
                        <div v-if="error" class="alert alert-danger mt-3">{{ error }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Module, handles setup -->
    <script>
        const authModule = {
            saveSettings() {
                localStorage.setItem(
                    'mfa-settings',
                    JSON.stringify({
                        domain: this.domain,
                        clientId: this.clientId,
                        audience: this.audience,
                        scopes: this.scopes
                    })
                );
            },

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('mfa-settings') || '{}');
                if (settings.domain) this.domain = settings.domain;
                if (settings.clientId) this.clientId = settings.clientId;
                if (settings.audience) this.audience = settings.audience;
                if (settings.scopes) this.scopes = settings.scopes;
            },

            createAuth0Client() {
                return new auth0.Auth0Client({
                    domain: this.domain,
                    clientId: this.clientId,
                    useRefreshTokens: true,
                    cacheLocation: 'localstorage',
                    authorizationParams: {
                        redirect_uri: `${window.location.origin}/mfa_flow.html`,
                        ...(this.audience && { audience: this.audience }),
                        ...(this.scopes && { scope: this.scopes })
                    }
                });
            },

            async initClient() {
                this.saveSettings();
                this.error = '';

                try {
                    this.auth0 = this.createAuth0Client();
                    this.isAuthenticated = await this.auth0.isAuthenticated();

                    if (this.isAuthenticated) {
                        this.user = await this.auth0.getUser();
                    } else {
                        await this.auth0.loginWithRedirect();
                    }
                } catch (e) {
                    this.error = e.message || e;
                }
            },

            async logout() {
                if (this.auth0) {
                    await this.auth0.logout({
                        logoutParams: {
                            returnTo: `${window.location.origin}/mfa_flow.html`
                        }
                    });
                }
            },

            async handleRedirectCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('code') || urlParams.has('state')) {
                    try {
                        this.auth0 = this.createAuth0Client();
                        await this.auth0.handleRedirectCallback();
                        window.history.replaceState({}, document.title, window.location.pathname);

                        this.isAuthenticated = await this.auth0.isAuthenticated();
                        if (this.isAuthenticated) {
                            this.user = await this.auth0.getUser();
                        }
                    } catch (e) {
                        this.error = e.message || e;
                    }
                }
            }
        };
    </script>

    <!-- MFA Module, Handles MFA-specific APIs -->
    <script>
        const mfaModule = {
            resetMfaFlow() {
                this.error = '';
                this.successMessage = '';
                this.tokens = null;
                this.mfaToken = null;
                this.mfaRequirements = null;
                this.authenticators = [];
                this.selectedAuthenticator = null;
                this.challengeData = null;
                this.verificationCode = '';
                this.enrollmentType = null;
                this.enrollmentData = null;
                this.enrollmentVerificationCode = '';
                this.phoneNumber = '';
                this.emailAddress = '';
                this.enrollmentFactors = [];
                this.enrollmentOptions = [];
                this.recoveryCodes = [];
                this.recoveryCodeInput = '';
            },

            async triggerMFA() {
                this.error = '';
                this.successMessage = '';
                this.tokens = null;
                this.mfaToken = null;
                this.mfaRequirements = null;
                this.authenticators = [];
                this.enrollmentFactors = [];
                this.enrollmentOptions = [];

                try {
                    await this.auth0.getTokenSilently({
                        cacheMode: "off",
                        authorizationParams: {
                            ...(this.audience && { audience: this.audience })
                        }
                    });
                } catch (e) {
                    if (e.error === 'mfa_required') {
                        this.mfaToken = e.mfa_token;
                        this.mfaRequirements = e.mfa_requirements || {};
                        // SDK automatically stores context, now we can call simplified methods
                        if (this.mfaRequirements.challenge) {
                            await this.getAuthenticators();
                        } else {
                            await this.getEnrollmentFactors();
                        }
                    } else {
                        this.error = e.message || e.error_description || e;
                    }
                }
            },

            async getEnrollmentFactors() {
                if (!this.mfaToken) {
                    return;
                }

                try {
                    // SDK automatically retrieves enrollment factors from stored context
                    this.enrollmentFactors = await this.auth0.mfa.getEnrollmentFactors(this.mfaToken);

                    // Map to UI options
                    const optionMap = {
                        'otp': {
                            type: 'otp',
                            label: 'Authenticator App (OTP)',
                            description: 'Use Google Authenticator, Okta Verify, or similar apps'
                        },
                        'oob': {
                            type: 'sms',
                            label: 'SMS',
                            description: 'Receive codes via text message'
                        },
                        'phone': {
                            type: 'sms',
                            label: 'SMS',
                            description: 'Receive codes via text message'
                        },
                        'email': {
                            type: 'email',
                            label: 'Email',
                            description: 'Receive codes via email'
                        }
                    };

                    this.enrollmentOptions = this.enrollmentFactors
                        .map(e => optionMap[e.type])
                        .filter(Boolean);
                } catch (e) {
                    // If context not found, it's okay - just no enrollment options
                    console.warn('Could not get enrollment factors:', e.message);
                    this.enrollmentFactors = [];
                    this.enrollmentOptions = [];
                }
            },

            async getAuthenticators() {
                if (!this.mfaToken) {
                    return;
                }

                this.loadingAuthenticators = true;
                this.error = '';

                try {
                    // SDK automatically filters by challenge types from context
                    this.authenticators = await this.auth0.mfa.getAuthenticators(this.mfaToken);
                } catch (e) {

                    this.error = e.message || e.error_description || e;
                } finally {
                    this.loadingAuthenticators = false;
                }
            },

            async challenge(authenticator) {
                this.selectedAuthenticator = authenticator;
                this.challengeData = null;
                this.verificationCode = '';
                this.error = '';
                this.loadingChallenge = true;

                try {
                    const challengeType = this.getChallengeType(authenticator.authenticatorType);
                    this.challengeData = await this.auth0.mfa.challenge({
                        mfaToken: this.mfaToken,
                        challengeType: challengeType,
                        authenticatorId: authenticator.id
                    });
                } catch (e) {
                    this.error = e.message || e.error_description || e;
                    this.selectedAuthenticator = null;
                } finally {
                    this.loadingChallenge = false;
                }
            },

            async verifyChallenge() {
                this.error = '';
                this.successMessage = '';
                this.loadingVerification = true;

                try {
                    // Build verify params - grant_type is inferred automatically
                    const verifyParams = {
                        mfaToken: this.mfaToken,
                        [this.getCodeParamName(this.selectedAuthenticator.authenticatorType)]: this.verificationCode
                    };

                    if (this.challengeData.oobCode) {
                        verifyParams.oobCode = this.challengeData.oobCode;
                    }

                    this.tokens = await this.auth0.mfa.verify(verifyParams);
                    this.successMessage = 'MFA Verification Successful!';

                    // Reset only the verification view
                    this.selectedAuthenticator = null;
                    this.challengeData = null;
                    this.verificationCode = '';
                } catch (e) {
                    if (e.error === 'mfa_required') {
                        this.mfaToken = e.mfa_token;
                        this.mfaRequirements = e.mfa_requirements || {};
                        this.error = '';
                        await this.getAuthenticators();
                    } else {
                        this.error = e.message || e.error_description || e;
                    }
                } finally {
                    this.loadingVerification = false;
                }
            },

            cancelVerification() {
                this.selectedAuthenticator = null;
                this.challengeData = null;
                this.verificationCode = '';
                this.error = '';
            },

            // Helper functions
            getChallengeType(authenticatorType) {
                const typeMap = {
                    'otp': 'otp',
                    'oob': 'oob',
                    'recovery-code': 'recovery-code'
                };
                return typeMap[authenticatorType] || authenticatorType;
            },

            getCodeParamName(authenticatorType) {
                const paramMap = {
                    'otp': 'otp',
                    'oob': 'bindingCode',
                    'recovery-code': 'recoveryCode'
                };
                return paramMap[authenticatorType] || 'otp';
            },

            // Enrollment methods
            selectEnrollmentType(type) {
                this.enrollmentType = type;
                this.error = '';

                // Auto-enroll for OTP (no additional input needed)
                if (type === 'otp') {
                    this.enrollOtp();
                }
            },

            async enrollOtp() {
                this.loadingEnrollment = true;
                this.error = '';

                try {
                    this.enrollmentData = await this.auth0.mfa.enroll({
                        mfaToken: this.mfaToken,
                        factorType: 'otp'
                    });
                } catch (e) {
                    this.error = e.message || e.error_description || e;
                    this.enrollmentType = null;
                } finally {
                    this.loadingEnrollment = false;
                }
            },

            async enrollOob() {
                this.loadingEnrollment = true;
                this.error = '';

                try {
                    this.enrollmentData = await this.auth0.mfa.enroll({
                        mfaToken: this.mfaToken,
                        factorType: this.enrollmentType, // 'sms' or 'voice'
                        phoneNumber: this.phoneNumber
                    });

                    // Capture recovery codes if present
                    if (this.enrollmentData && this.enrollmentData.recoveryCodes) {
                        this.recoveryCodes = this.enrollmentData.recoveryCodes;
                    }
                } catch (e) {
                    this.error = e.message || e.error_description || e;
                    this.enrollmentType = null;
                    this.phoneNumber = '';
                } finally {
                    this.loadingEnrollment = false;
                }
            },

            async enrollEmail() {
                this.loadingEnrollment = true;
                this.error = '';

                try {
                    const params = {
                        mfaToken: this.mfaToken,
                        factorType: 'email'
                    };

                    if (this.emailAddress) {
                        params.email = this.emailAddress;
                    }

                    this.enrollmentData = await this.auth0.mfa.enroll(params);

                    // Capture recovery codes if present
                    if (this.enrollmentData && this.enrollmentData.recoveryCodes) {
                        this.recoveryCodes = this.enrollmentData.recoveryCodes;
                    }
                } catch (e) {
                    this.error = e.message || e.error_description || e;
                    this.enrollmentType = null;
                    this.emailAddress = '';
                } finally {
                    this.loadingEnrollment = false;
                }
            },

            async verifyEnrollment() {
                this.error = '';
                this.successMessage = '';
                this.loadingEnrollmentVerification = true;

                try {
                    // Build verify params - grant_type is inferred automatically
                    const verifyParams = {
                        mfaToken: this.mfaToken
                    };

                    if (this.enrollmentType === 'otp') {
                        verifyParams.otp = this.enrollmentVerificationCode;
                    } else {
                        verifyParams.oobCode = this.enrollmentData.oobCode;
                        verifyParams.bindingCode = this.enrollmentVerificationCode;
                    }

                    this.tokens = await this.auth0.mfa.verify(verifyParams);
                    this.successMessage = `${this.enrollmentType.toUpperCase()} Authenticator enrolled successfully!`;

                    // Reset enrollment state
                    this.enrollmentType = null;
                    this.enrollmentData = null;
                    this.enrollmentVerificationCode = '';
                    this.phoneNumber = '';
                    this.emailAddress = '';

                    // Refresh authenticators and enrollment factors
                    if (this.mfaRequirements.challenge) {
                        await this.getAuthenticators();
                    } else {
                        await this.getEnrollmentFactors();
                    }

                } catch (e) {
                    this.error = e.message || e.error_description || e;
                } finally {
                    this.loadingEnrollmentVerification = false;
                }
            },

            cancelEnrollment() {
                this.enrollmentType = null;
                this.enrollmentData = null;
                this.enrollmentVerificationCode = '';
                this.phoneNumber = '';
                this.emailAddress = '';
                this.error = '';
            },

            async verifyWithRecoveryCode() {
                this.error = '';
                this.successMessage = '';
                this.loadingRecoveryVerification = true;

                try {
                    // grant_type is inferred from recoveryCode field
                    const verifyParams = {
                        mfaToken: this.mfaToken,
                        recoveryCode: this.recoveryCodeInput
                    };

                    this.tokens = await this.auth0.mfa.verify(verifyParams);
                    this.successMessage = 'MFA Verification with Recovery Code Successful!';

                    // Clear recovery codes and input after successful verification
                    this.recoveryCodes = [];
                    this.recoveryCodeInput = '';
                } catch (e) {
                    this.error = e.message || e.error_description || e;
                } finally {
                    this.loadingRecoveryVerification = false;
                }
            }
        };
    </script>

    <!-- Vue App, combines authentication and MFA modules -->
    <script>
        window.app = new Vue({
            el: '#app',
            data() {
                const settings = JSON.parse(localStorage.getItem('mfa-settings') || '{}');
                return {
                    // Configuration
                    domain: settings.domain,
                    clientId: settings.clientId,
                    audience: settings.audience,
                    scopes: settings.scopes,
                    // Auth state
                    auth0: null,
                    isAuthenticated: false,
                    user: null,
                    // MFA state
                    mfaToken: null,
                    mfaRequirements: null,
                    authenticators: [],
                    selectedAuthenticator: null,
                    challengeData: null,
                    verificationCode: '',
                    // Enrollment state
                    enrollmentType: null,
                    enrollmentData: null,
                    enrollmentVerificationCode: '',
                    phoneNumber: '',
                    emailAddress: '',
                    enrollmentFactors: [],
                    enrollmentOptions: [],
                    // Recovery codes state
                    recoveryCodes: [],
                    recoveryCodeInput: '',
                    loadingRecoveryVerification: false,
                    // UI state
                    loadingAuthenticators: false,
                    loadingChallenge: false,
                    loadingVerification: false,
                    loadingEnrollment: false,
                    loadingEnrollmentVerification: false,
                    successMessage: '',
                    tokens: null,
                    error: ''
                };
            },
            computed: {
                hasEnrollmentOptions() {
                    return this.enrollmentFactors.length > 0;
                }
            },
            methods: {
                // Combine both modules
                ...authModule,
                ...mfaModule
            },
            async mounted() {
                this.loadSettings();
                await this.handleRedirectCallback();
            }
        });
    </script>
</body>

</html>